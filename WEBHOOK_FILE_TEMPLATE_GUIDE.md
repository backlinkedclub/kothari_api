# Webhook File Template - Where Code Gets Written

## Two Places Where Files Are Written

### 1. `Webhook()` - Initial Creation (Lines 527-550)

**Location:** `src/kothari_api/controller.cr` lines 527-550

**Template:**
```crystal
webhook_file_content = <<-CRYSTAL
# Webhook method: #{action_name}
# Auto-generated by Webhook() helper
# File: app/webhooks/#{controller_name}/#{action_name}.cr
#
# This file can be edited directly for meta-programming and updates.
# The method is automatically included in #{webhook_class_name} via module inclusion

module KothariAPI
  module Webhooks
    module #{module_name}
      # Webhook endpoint: /webhooks/#{controller_name}/#{action_name}
      def #{action_name}
        data = json_body
        # TODO: Implement webhook logic here
        json({status: "received", action: "#{action_name}"})
      end
    end
  end
end

# Include the method in the webhook controller
#{webhook_class_name}.include(KothariAPI::Webhooks::#{module_name})
CRYSTAL
```

**This is the DEFAULT template when creating a new webhook.**

---

### 2. `Webhook.update()` - Rewriting (Lines 707-728)

**Location:** `src/kothari_api/controller.cr` lines 707-728

**Template:**
```crystal
new_file_content = <<-CRYSTAL
# Webhook method: #{action_name}
# Auto-generated by Webhook() helper
# File: app/webhooks/#{controller_name}/#{action_name}.cr
#
# This file can be edited directly for meta-programming and updates.
# Last updated: #{Time.utc.to_s}

module KothariAPI
  module Webhooks
    module #{module_name}
      # Webhook endpoint: /webhooks/#{controller_name}/#{action_name}
      def #{action_name}
#{method_body.split("\n").map { |line| "        #{line}" }.join("\n")}
      end
    end
  end
end

# Include the method in the webhook controller
#{webhook_class_name}.include(KothariAPI::Webhooks::#{module_name})
CRYSTAL
```

**KEY LINE:** Line 720 - This is where your `method_body` gets inserted!

```crystal
#{method_body.split("\n").map { |line| "        #{line}" }.join("\n")}
```

This takes your `method_body` string, splits it by lines, adds 8 spaces of indentation to each line, and inserts it into the method.

---

## How to Customize

### Option 1: Modify the Template Directly

Edit `src/kothari_api/controller.cr` line 707-728 to change the template structure:

```crystal
new_file_content = <<-CRYSTAL
# Custom header comment
# Profile: #{action_name}
# Updated: #{Time.utc.to_s}

module KothariAPI
  module Webhooks
    module #{module_name}
      def #{action_name}
        # Your custom wrapper code here
        begin
#{method_body.split("\n").map { |line| "          #{line}" }.join("\n")}
        rescue ex
          error_response("Webhook error: #{ex.message}")
        end
      end
    end
  end
end

#{webhook_class_name}.include(KothariAPI::Webhooks::#{module_name})
CRYSTAL
```

### Option 2: Pass Pre-Formatted Code

When calling `Webhook.update()`, pass a complete method body with proper indentation:

```crystal
method_body = <<-CRYSTAL
        data = json_body
        from = data["From"]?.try &.to_s
        
        # Your logic here
        json({status: "ok"})
CRYSTAL

Webhook.update(controller_name: "twilio", action_name: "profile_1", method_body: method_body)
```

The template will add 8 more spaces, so your code should already be indented as if it's inside the method.

---

## Example: Custom Template with Error Handling

```crystal
# In src/kothari_api/controller.cr, line 707-728
new_file_content = <<-CRYSTAL
# Webhook method: #{action_name}
# Auto-generated by Webhook.update() helper
# Last updated: #{Time.utc.to_s}

module KothariAPI
  module Webhooks
    module #{module_name}
      def #{action_name}
        data = json_body
        
        # Log incoming webhook
        puts "Webhook received: #{action_name}"
        
        begin
          # Your generated logic here
#{method_body.split("\n").map { |line| "          #{line}" }.join("\n")}
        rescue ex
          puts "Webhook error: #{ex.message}"
          error_response("Webhook processing failed")
        end
      end
    end
  end
end

#{webhook_class_name}.include(KothariAPI::Webhooks::#{module_name})
CRYSTAL
```

This adds logging and error handling around your generated code!
