# Webhook() Helper Method - Usage Guide

## Overview

The `Webhook()` helper method allows you to dynamically create webhook methods and routes from **any controller method**. It creates separate files for each webhook method, enabling meta-programming and easy updates.

## Usage

### From Any Controller

```crystal
class HomeController < KothariAPI::Controller
  def create
    # This will automatically:
    # 1. Create app/webhooks/twilio/new_method.cr
    # 2. Add require to twilio_webhook_controller.cr
    # 3. Add route: POST /webhooks/twilio/new_method
    # 4. Return the webhook URL
    webhook_url = Webhook(controller_name: "twilio", action_name: "new_method")
    
    json({
      message: "Webhook created!",
      webhook_url: webhook_url,
      note: "Restart server to use the new endpoint"
    })
  end
end
```

## What Gets Created

### 1. Webhook Method File

**File:** `app/webhooks/twilio/new_method.cr`

```crystal
# Webhook method: new_method
# Auto-generated by Webhook() helper
# File: app/webhooks/twilio/new_method.cr
#
# This file can be edited directly for meta-programming and updates.
# The method is automatically included in TwilioWebhookController via module inclusion

module KothariAPI
  module Webhooks
    module TwilioNewMethodWebhook
      # Webhook endpoint: /webhooks/twilio/new_method
      def new_method
        data = json_body
        # TODO: Implement webhook logic here
        json({status: "received", action: "new_method"})
      end
    end
  end
end

# Include the method in the webhook controller
TwilioWebhookController.include(KothariAPI::Webhooks::TwilioNewMethodWebhook)
```

### 2. Require Statement Added

**File:** `app/controllers/twilio_webhook_controller.cr`

```crystal
require "../../../src/kothari_api/controller"
require "./webhooks/twilio/new_method"  # ← Auto-added

class TwilioWebhookController < KothariAPI::Controller
  # ...
end
```

### 3. Route Added

**File:** `config/routes.cr`

```crystal
KothariAPI::Router::Router.draw do |r|
  r.get "/", to: "home#index"
  r.post "/webhooks/twilio/new_method", to: "twilio_webhook#new_method"  # ← Auto-added
end
```

## Benefits of Separate Files

### 1. Meta-Programming

Each webhook method is in its own file, so you can:

```crystal
# app/webhooks/twilio/new_method.cr
module KothariAPI
  module Webhooks
    module TwilioNewMethodWebhook
      def new_method
        data = json_body
        
        # You can add logging, validation, etc.
        log_webhook_event("new_method", data)
        
        # Process webhook
        result = process_webhook(data)
        
        json({status: "processed", result: result})
      end
      
      private def log_webhook_event(action, data)
        # Custom logging logic
      end
      
      private def process_webhook(data)
        # Custom processing logic
      end
    end
  end
end

TwilioWebhookController.include(KothariAPI::Webhooks::TwilioNewMethodWebhook)
```

### 2. Easy Updates

Update individual webhook methods without touching the controller:

```crystal
# app/webhooks/twilio/new_method.cr
# Just edit this file directly - no need to modify the controller
```

### 3. Organization

All webhook methods are organized in `app/webhooks/<controller>/`:

```
app/
  webhooks/
    twilio/
      new_method.cr
      incoming_call.cr
      incoming_sms.cr
    stripe/
      payment_succeeded.cr
      payment_failed.cr
```

## Complete Example

### Step 1: Create Webhook Controller

```bash
kothari webhook twilio
```

### Step 2: Use Webhook() Helper

```crystal
# app/controllers/home_controller.cr
class HomeController < KothariAPI::Controller
  def create
    webhook_url = Webhook(controller_name: "twilio", action_name: "incoming_call")
    json({webhook_url: webhook_url})
  end
end
```

### Step 3: Edit the Generated File

```crystal
# app/webhooks/twilio/incoming_call.cr
module KothariAPI
  module Webhooks
    module TwilioIncomingCallWebhook
      def incoming_call
        data = json_body
        from = data["From"]?.try &.to_s
        to = data["To"]?.try &.to_s
        
        # Your custom logic here
        save_call_log(from, to)
        send_notification(from, to)
        
        json({status: "processed", from: from, to: to})
      end
      
      private def save_call_log(from, to)
        # Save to database
      end
      
      private def send_notification(from, to)
        # Send notification
      end
    end
  end
end

TwilioWebhookController.include(KothariAPI::Webhooks::TwilioIncomingCallWebhook)
```

### Step 4: Restart Server

```bash
kothari server
```

The webhook endpoint is now available at:
```
POST /webhooks/twilio/incoming_call
```

## How It Works

1. **File Creation**: Creates `app/webhooks/<controller>/<action>.cr`
2. **Module Definition**: Defines a module with the webhook method
3. **Module Inclusion**: Includes the module in the webhook controller
4. **Require Statement**: Adds `require "./webhooks/<controller>/<action>"` to controller
5. **Route Generation**: Adds route to `config/routes.cr`

## Notes

- **Server Restart Required**: After calling `Webhook()`, restart the server to pick up new routes
- **Idempotent**: Calling `Webhook()` multiple times with the same parameters is safe (returns existing URL)
- **File-Based**: Each webhook method is in its own file for easy meta-programming and updates
