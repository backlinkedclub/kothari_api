# Multi-Business Webhook Configuration Example
## WhatsApp/Twilio Webhooks for 3 Different Businesses

## Scenario

You're building a SaaS platform where 3 businesses (Business A, Business B, Business C) each need their own WhatsApp webhook endpoints for Twilio integration.

## Setup

### Step 1: Create Webhook Controller

```bash
kothari webhook twilio
```

This creates `app/controllers/twilio_webhook_controller.cr`

### Step 2: Create Business Model

```bash
kothari g scaffold business name:string api_key:string webhook_url:string
kothari db:migrate
```

### Step 3: Create Business Registration Endpoint

```crystal
# app/controllers/businesses_controller.cr
class BusinessesController < KothariAPI::Controller
  def create
    data = json_body
    business = Business.create(
      name: data["name"].to_s,
      api_key: data["api_key"].to_s,
      webhook_url: nil
    )
    
    # Generate unique webhook endpoint for this business
    # Format: /webhooks/twilio/business_<business_id>_whatsapp
    business_id = business.id.not_nil!
    webhook_action = "business_#{business_id}_whatsapp"
    
    # Use Webhook() helper to create the endpoint
    webhook_url = Webhook(controller_name: "twilio", action_name: webhook_action)
    
    # Update business with webhook URL
    business.update_webhook_url(webhook_url)
    
    json_post({
      business: business,
      webhook_url: webhook_url,
      instructions: "Configure this URL in your Twilio WhatsApp settings"
    })
  end
end
```

## What Gets Created

### For Business A (ID: 1)

**File Created:** `app/webhooks/twilio/business_1_whatsapp.cr`

```crystal
# Webhook method: business_1_whatsapp
# Auto-generated by Webhook() helper
# File: app/webhooks/twilio/business_1_whatsapp.cr
#
# This file handles WhatsApp webhooks for Business A
# Edit this file to customize webhook logic for this specific business

module KothariAPI
  module Webhooks
    module TwilioBusiness1WhatsappWebhook
      # Webhook endpoint: /webhooks/twilio/business_1_whatsapp
      def business_1_whatsapp
        data = json_body
        
        # Get business-specific configuration
        business = Business.find(1)
        return unauthorized("Business not found") unless business
        
        # Verify webhook signature (Twilio-specific)
        signature = context.request.headers["X-Twilio-Signature"]?
        if !verify_twilio_signature(signature, data, business.api_key)
          return unauthorized("Invalid signature")
        end
        
        # Process WhatsApp message
        from = data["From"]?.try &.to_s
        body = data["Body"]?.try &.to_s
        message_sid = data["MessageSid"]?.try &.to_s
        
        # Business-specific logic
        process_whatsapp_message(business, from, body, message_sid)
        
        json({status: "received", business: business.name})
      end
      
      private def process_whatsapp_message(business, from, body, message_sid)
        # Save message to database
        Message.create(
          business_id: business.id,
          from: from,
          body: body,
          message_sid: message_sid,
          source: "whatsapp"
        )
        
        # Business-specific automation
        case business.name
        when "Business A"
          # Auto-reply for Business A
          send_auto_reply(business, from, "Thanks for contacting Business A!")
        when "Business B"
          # Forward to CRM for Business B
          forward_to_crm(business, from, body)
        when "Business C"
          # Custom logic for Business C
          handle_business_c_message(business, from, body)
        end
      end
      
      private def verify_twilio_signature(signature, data, api_key)
        # Twilio signature verification logic
        # Implementation depends on your Twilio setup
        true
      end
      
      private def send_auto_reply(business, to, message)
        # Send WhatsApp reply via Twilio API
      end
      
      private def forward_to_crm(business, from, body)
        # Forward message to CRM system
      end
      
      private def handle_business_c_message(business, from, body)
        # Custom logic for Business C
      end
    end
  end
end

TwilioWebhookController.include(KothariAPI::Webhooks::TwilioBusiness1WhatsappWebhook)
```

**Route Added:**
```crystal
r.post "/webhooks/twilio/business_1_whatsapp", to: "twilio_webhook#business_1_whatsapp"
```

**Webhook URL for Business A:**
```
https://yourdomain.com/webhooks/twilio/business_1_whatsapp
```

### For Business B (ID: 2)

**File Created:** `app/webhooks/twilio/business_2_whatsapp.cr`

```crystal
# Webhook method: business_2_whatsapp
# Auto-generated by Webhook() helper
# File: app/webhooks/twilio/business_2_whatsapp.cr
#
# This file handles WhatsApp webhooks for Business B

module KothariAPI
  module Webhooks
    module TwilioBusiness2WhatsappWebhook
      def business_2_whatsapp
        data = json_body
        business = Business.find(2)
        
        # Business B specific logic
        # Maybe they want messages forwarded to Slack
        forward_to_slack(business, data)
        
        json({status: "processed", business: "Business B"})
      end
      
      private def forward_to_slack(business, data)
        # Forward to Slack webhook
      end
    end
  end
end

TwilioWebhookController.include(KothariAPI::Webhooks::TwilioBusiness2WhatsappWebhook)
```

**Webhook URL for Business B:**
```
https://yourdomain.com/webhooks/twilio/business_2_whatsapp
```

### For Business C (ID: 3)

**File Created:** `app/webhooks/twilio/business_3_whatsapp.cr`

```crystal
# Webhook method: business_3_whatsapp
# Auto-generated by Webhook() helper
# File: app/webhooks/twilio/business_3_whatsapp.cr
#
# This file handles WhatsApp webhooks for Business C

module KothariAPI
  module Webhooks
    module TwilioBusiness3WhatsappWebhook
      def business_3_whatsapp
        data = json_body
        business = Business.find(3)
        
        # Business C wants AI chatbot integration
        ai_response = get_ai_response(data["Body"]?.to_s)
        send_whatsapp_reply(business, data["From"]?.to_s, ai_response)
        
        json({status: "processed", business: "Business C"})
      end
      
      private def get_ai_response(message)
        # Call AI API for chatbot response
      end
      
      private def send_whatsapp_reply(business, to, message)
        # Send reply via Twilio
      end
    end
  end
end

TwilioWebhookController.include(KothariAPI::Webhooks::TwilioBusiness3WhatsappWebhook)
```

**Webhook URL for Business C:**
```
https://yourdomain.com/webhooks/twilio/business_3_whatsapp
```

## Complete Flow

### 1. Business Registration

```bash
POST /businesses
{
  "name": "Business A",
  "api_key": "twilio_api_key_123"
}
```

**Response:**
```json
{
  "business": {
    "id": 1,
    "name": "Business A",
    "webhook_url": "/webhooks/twilio/business_1_whatsapp"
  },
  "webhook_url": "/webhooks/twilio/business_1_whatsapp",
  "instructions": "Configure this URL in your Twilio WhatsApp settings"
}
```

### 2. Configure in Twilio

Each business configures their Twilio WhatsApp number to send webhooks to:
- **Business A**: `https://yourdomain.com/webhooks/twilio/business_1_whatsapp`
- **Business B**: `https://yourdomain.com/webhooks/twilio/business_2_whatsapp`
- **Business C**: `https://yourdomain.com/webhooks/twilio/business_3_whatsapp`

### 3. When Messages Arrive

When a WhatsApp message arrives for Business A:
1. Twilio sends POST to `/webhooks/twilio/business_1_whatsapp`
2. Router matches the route
3. Calls `TwilioWebhookController#business_1_whatsapp`
4. Method in `app/webhooks/twilio/business_1_whatsapp.cr` executes
5. Business-specific logic runs (auto-reply, CRM forwarding, etc.)

## File Structure

```
app/
  controllers/
    twilio_webhook_controller.cr
    businesses_controller.cr
  webhooks/
    twilio/
      business_1_whatsapp.cr    ← Business A's webhook
      business_2_whatsapp.cr    ← Business B's webhook
      business_3_whatsapp.cr    ← Business C's webhook
  models/
    business.cr
    message.cr
```

## Advanced: Dynamic Webhook Creation

You can also create webhooks dynamically when a business signs up:

```crystal
# app/controllers/businesses_controller.cr
class BusinessesController < KothariAPI::Controller
  def create
    data = json_body
    business = Business.create(
      name: data["name"].to_s,
      api_key: data["api_key"].to_s
    )
    
    # Generate webhook endpoint
    business_id = business.id.not_nil!
    webhook_action = "business_#{business_id}_whatsapp"
    
    # Create webhook method and route
    webhook_url = Webhook(controller_name: "twilio", action_name: webhook_action)
    
    # Update business record
    business.update(webhook_url: webhook_url)
    
    json_post({
      business: business,
      webhook_url: "https://yourdomain.com#{webhook_url}",
      twilio_setup: {
        webhook_url: "https://yourdomain.com#{webhook_url}",
        method: "POST"
      }
    })
  end
end
```

## Benefits

1. **Isolated Logic**: Each business's webhook logic is in its own file
2. **Easy Updates**: Update Business A's webhook without affecting others
3. **Meta-Programming**: Add features to specific business webhooks
4. **Scalable**: Add 100 businesses, each gets their own webhook file
5. **Organized**: All webhooks in `app/webhooks/twilio/`

## Real-World Example

```crystal
# When Business A signs up:
POST /businesses
→ Creates business_1_whatsapp.cr
→ Returns: /webhooks/twilio/business_1_whatsapp

# Business A configures in Twilio:
Webhook URL: https://api.example.com/webhooks/twilio/business_1_whatsapp

# When someone sends WhatsApp to Business A's number:
Twilio → POST /webhooks/twilio/business_1_whatsapp
→ business_1_whatsapp.cr executes
→ Business A's custom logic runs
```

This approach scales to any number of businesses, each with their own isolated webhook logic!
